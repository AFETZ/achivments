sequenceDiagram
  actor Client
  participant Web as Web Server
  participant App as App Server
  participant DB as SQLite DB
  participant Log as Logger

  Client->>Web: POST /api/increment {n}
  Web->>Web: Validate JSON & range
  alt invalid input
    Web-->>Client: 400 {error}
  else valid
    Web->>App: POST /process {n}
    App->>DB: BEGIN IMMEDIATE
    App->>DB: SELECT 1 WHERE value=n
    alt duplicate
      App->>Log: warn Duplicate
      App->>DB: ROLLBACK
      App-->>Web: 409 {Duplicate}
      Web-->>Client: 409 {error}
    else not duplicate
      App->>DB: SELECT 1 WHERE value=n+1
      alt predecessor exists
        App->>Log: warn PredecessorProcessed
        App->>DB: ROLLBACK
        App-->>Web: 422 {PredecessorProcessed}
        Web-->>Client: 422 {error}
      else ok
        App->>DB: INSERT(n, processed_at)
        App->>DB: COMMIT
        App->>Log: info processed
        App-->>Web: 200 {result:n+1}
        Web-->>Client: 200 {result:n+1}
      end
    end
  end
